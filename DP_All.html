<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dienstpläne</title>

  <!-- iOS / App-Feeling -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Dienstpläne">
  <link rel="apple-touch-icon" href="/dp_intern/icon-192.png?v=01">

  <!-- Manifest / PWA -->
  <link rel="manifest" href="/dp_intern/manifest/manifest_DP_All.json?v=01">
  <meta name="theme-color" content="#ffffff">

  <!-- OG / WhatsApp (neutral) -->
  <meta property="og:title" content="Dienstpläne">
  <meta property="og:description" content="Alle persönlichen Dienstpläne – Auswahl per Liste.">
  <meta property="og:image" content="https://cleando-ws.github.io/dp_intern/icon-512.png?v=01">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cleando-ws.github.io/dp_intern/DP_All.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://cleando-ws.github.io/dp_intern/icon-512.png?v=01">

  <style>
    :root { --bg:#0b1220; --card:#111827; --fg:#e7eefb; --muted:#98a2b3; --brand:#3b82f6; }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:min(760px,92%); background:var(--card); border:1px solid var(--brand); border-radius:18px; padding:22px; box-shadow:0 12px 40px rgba(0,0,0,.45); }
    h1 { margin:0 0 6px 0; font-size:1.25rem; letter-spacing:.2px; }
    .muted { color:var(--muted); margin:0 0 16px 0; }
    .row { display:flex; gap:12px; margin:12px 0; flex-wrap:wrap; }
    .row > * { flex:1 1 220px; }
    input[type="text"] { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #263247; background:#0f172a; color:var(--fg); outline:none; }
    .listbox { border:1px solid #263247; border-radius:12px; background:#0f172a; max-height:380px; overflow:auto; padding:6px; }
    .item { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-radius:10px; cursor:pointer; user-select:none; }
    .item:hover { background:#0d1b34; }
    .item.active { outline:2px solid #3b82f6; background:#0d1b34; }
    .empty { color:var(--muted); padding:14px; text-align:center; }
    button { width:100%; padding:12px 16px; border-radius:12px; border:1px solid transparent; font-weight:700; cursor:pointer; }
    .primary { background:linear-gradient(135deg,#22c55e,#38bdf8); color:#07131f; }
    .secondary { background:#0f172a; color:var(--fg); border-color:#263247; }
    .status { min-height:20px; font-size:.9rem; color:var(--muted); margin-top:6px; }
    .footer { margin-top:16px; font-size:.85rem; color:var(--muted); }
  </style>

  <script>
    const LINKS_URL = "/dp_intern/links/Onedrive-Links.json?v=01";
    const KEY_LAST  = "dp_all_last";
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function absoluteUrl(fileBase) {
      return new URL("/dp_intern/" + fileBase + ".html", location.origin).href;
    }

    let items = [], filtered = [];

    function renderList() {
      const box = $('.listbox');
      box.innerHTML = '';

      if (!filtered.length) {
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'Keine Ergebnisse';
        box.appendChild(d);
        return;
      }

      const last = localStorage.getItem(KEY_LAST);

      for (const it of filtered) {
        const row = document.createElement('div');
        row.className = 'item';
        row.tabIndex = 0;
        row.dataset.fileBase = it.file_base;
        row.innerHTML = `<span>${it.display_name}</span><span style="opacity:.6">›</span>`;

        if (it.file_base === last) row.classList.add('active');

        row.addEventListener('click', () => selectRow(row));
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') openSelected();
          if (e.key === 'c' && (e.ctrlKey || e.metaKey)) copySelected();
          if (e.key === 'ArrowDown') focusSibling(row, +1);
          if (e.key === 'ArrowUp')   focusSibling(row, -1);
        });

        box.appendChild(row);
      }

      if (!$('.item.active') && $('.item')) selectRow($('.item'));
    }

    function focusSibling(row, dir) {
      const all = $$('.item');
      const idx = all.indexOf(row);
      const next = all[idx + dir];
      if (next) next.focus();
    }

    function selectRow(row) {
      $$('.item.active').forEach(el => el.classList.remove('active'));
      row.classList.add('active');
      localStorage.setItem(KEY_LAST, row.dataset.fileBase);
    }

    function getActive() {
      const a = $('.item.active');
      return a ? a.dataset.fileBase : null;
    }

    async function loadList() {
      const st = $('.status');
      try {
        st.textContent = 'Lade Liste…';
        const res = await fetch(LINKS_URL, { cache: 'no-cache' });
        if (!res.ok) throw 0;
        const arr = await res.json();

        items = (arr || [])
          .filter(x => x.display_name && x.file_base)
          .map(x => ({ display_name: x.display_name, file_base: x.file_base }))
          .sort((a, b) => a.display_name.localeCompare(b.display_name, 'de', { sensitivity: 'base' }));

        filtered = items.slice();
        st.textContent = '';
        renderList();
      } catch {
        st.textContent = 'Liste konnte nicht geladen werden.';
      }
    }

    function applyFilter() {
      const q = $('#search').value.trim().toLowerCase();
      filtered = q ? items.filter(x => x.display_name.toLowerCase().includes(q)) : items.slice();
      renderList();
    }

    function openSelected() {
      const fb = getActive();
      if (fb) location.href = "/dp_intern/" + fb + ".html";
    }

    async function copySelected() {
      const fb = getActive();
      if (!fb) return;
      const url = absoluteUrl(fb);
      const st = $('.status');
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(url);
        } else {
          const ta = document.createElement('textarea');
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        st.textContent = 'Link kopiert.';
        setTimeout(() => st.textContent = '', 2000);
      } catch {
        st.textContent = 'Kopieren nicht möglich.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadList();
      $('#search').addEventListener('input', applyFilter);
      $('#open').addEventListener('click', openSelected);
      $('#copy').addEventListener('click', copySelected);

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/dp_intern/sw.js?v=01').catch(console.error);
      }
    });
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card" role="region" aria-label="Dienstpläne">
      <h1>Dienstpläne</h1>
      <p class="muted">Mitarbeiter auswählen und Dienstplan öffnen oder Link kopieren.</p>

      <div class="row">
        <input id="search" type="text" placeholder="Suche nach Name …" aria-label="Suche">
      </div>

      <div class="listbox" role="listbox" aria-label="Mitarbeiterliste"></div>

      <div class="row">
        <button id="open" class="primary">Öffnen</button>
        <button id="copy" class="secondary">Link kopieren</button>
      </div>

      <div class="status" aria-live="polite"></div>
      <div class="footer">Quelle: <code>/dp_intern/links/Onedrive-Links.json</code></div>
    </section>
  </main>
</body>
</html>
