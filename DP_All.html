<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dienstpläne</title>

  <!-- iOS / App-Feeling -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Dienstpläne">
  <link rel="apple-touch-icon" href="/dp_intern/icon-192.png?v=01">

  <!-- Manifest / PWA -->
  <link rel="manifest" href="/dp_intern/manifest/manifest_DP_All.json?v=01">
  <meta name="theme-color" content="#ffffff">

  <!-- OG / WhatsApp (neutral) -->
  <meta property="og:title" content="Dienstpläne">
  <meta property="og:description" content="Alle persönlichen Dienstpläne – Auswahl per Liste.">
  <meta property="og:image" content="https://cleando-ws.github.io/dp_intern/icon-512.png?v=01">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://cleando-ws.github.io/dp_intern/icon-512.png?v=01">

  <style>
    :root{
      --bg:    #0b1220;
      --card:  #111827;
      --fg:    #e7eefb;
      --muted: #98a2b3;
      --brand: #3b82f6;
    }

    *{ box-sizing:border-box; }

    html, body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--fg);
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .card{
      width:min(760px,92%);
      background:var(--card);
      border:1px solid var(--brand);
      border-radius:18px;
      padding:22px;
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.25rem;
      letter-spacing:.2px;
    }

    .muted{
      color:var(--muted);
      margin:0 0 16px 0;
    }

    .row{
      display:flex;
      gap:12px;
      margin:12px 0;
      flex-wrap:wrap;
    }

    .row > *{
      flex:1 1 220px;
    }

    /* Dropdown Button */
    .selector{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #263247;
      background:#0f172a;
      color:var(--fg);
      cursor:pointer;
      font-weight:600;
    }

    .placeholder{
      color:#7f8aa0;
    }

    .chev{
      opacity:.7;
      font-size:1.05rem;
    }

    /* Panel (Dropdown Liste) */
    .panel{
      display:none;
      margin-top:10px;
      border:1px solid #263247;
      border-radius:12px;
      background:#0f172a;
      padding:10px;
    }

    .panel.open{
      display:block;
    }

    .search{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #263247;
      background:#0e1527;
      color:var(--fg);
      outline:none;
    }

    .listbox{
      margin-top:10px;
      max-height:360px;
      overflow:auto;
      border-radius:10px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      user-select:none;
    }

    .item:hover{
      background:#0d1b34;
    }

    .item.active{
      outline:2px solid #3b82f6;
      background:#0d1b34;
    }

    .empty{
      color:var(--muted);
      padding:12px;
      text-align:center;
    }

    button{
      width:100%;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid transparent;
      font-weight:700;
      cursor:pointer;
    }

    .primary{
      background:linear-gradient(135deg,#22c55e,#38bdf8);
      color:#07131f;
    }

    .secondary{
      background:#0f172a;
      color:var(--fg);
      border-color:#263247;
    }

    .status{
      min-height:20px;
      font-size:.9rem;
      color:var(--muted);
      margin-top:6px;
    }

    .footer{
      margin-top:16px;
      font-size:.85rem;
      color:var(--muted);
    }
  </style>

  <script>
    // Quelle der Tabelle
    const LINKS_URL = "/dp_intern/data/data.json?v=01";

    // Wird beim Auswählen weiterhin geschrieben, aber nicht mehr automatisch ausgelesen
    const KEY_LAST = "dp_all_last";

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function absoluteUrl(fileBase){
      return new URL("/dp_intern/" + fileBase + ".html", location.origin).href;
    }

    let items    = [];
    let filtered = [];
    let selected = null; // {display_name, file_base}

    function setSelectorLabel(name){
      const label = $('#selectorLabel');
      const isPlaceholder = !name;
      label.textContent = isPlaceholder ? 'Mitarbeiter wählen' : name;
      label.classList.toggle('placeholder', isPlaceholder);
    }

    function togglePanel(){
      const panel = $('.panel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')){
        $('#search').focus();
      }
    }

    function closePanel(){
      $('.panel').classList.remove('open');
    }

    function renderList(){
      const box = $('.listbox');
      box.innerHTML = '';

      if (!filtered.length){
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'Keine Ergebnisse';
        box.appendChild(d);
        return;
      }

      for (const it of filtered){
        const row = document.createElement('div');
        row.className = 'item';
        row.tabIndex = 0;
        row.dataset.fileBase = it.file_base;
        row.innerHTML = `<span>${it.display_name}</span><span style="opacity:.6">›</span>`;

        if (selected && selected.file_base === it.file_base){
          row.classList.add('active');
        }

        row.addEventListener('click', () => choose(it));
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') choose(it);
        });

        box.appendChild(row);
      }
    }

    function applyFilter(){
      const q = $('#search').value.trim().toLowerCase();
      filtered = q
        ? items.filter(x => x.display_name.toLowerCase().includes(q))
        : items.slice();
      renderList();
    }

    function choose(it){
      selected = it;
      // weiter speichern erlaubt, aber beim Start nicht mehr genutzt
      localStorage.setItem(KEY_LAST, it.file_base);
      setSelectorLabel(it.display_name);
      closePanel();
      $$('.item').forEach(el => {
        el.classList.toggle('active', el.dataset.fileBase === it.file_base);
      });
    }

    async function loadList(){
      const st = $('.status');
      try{
        st.textContent = 'Lade Liste…';
        const res = await fetch(LINKS_URL, { cache:'no-cache' });
        if (!res.ok) throw 0;
        const arr = await res.json();

        items = (arr || [])
          .filter(x => x.display_name && x.file_base)
          .map(x => ({
            display_name: x.display_name,
            file_base:    x.file_base
          }))
          .sort((a, b) =>
            a.display_name.localeCompare(b.display_name, 'de', { sensitivity:'base' })
          );

        filtered = items.slice();

        // immer mit Platzhalter starten, keine Vorauswahl
        selected = null;
        setSelectorLabel(null);

        st.textContent = '';
        renderList();
      } catch(e){
        console.error(e);
        st.textContent = 'Liste konnte nicht geladen werden.';
      }
    }

    function openSelected(){
      if (!selected){
        alert('Bitte zuerst Mitarbeiter wählen.');
        return;
      }
      location.href = "/dp_intern/" + selected.file_base + ".html";
    }

    async function copySelected(){
      if (!selected){
        alert('Bitte zuerst Mitarbeiter wählen.');
        return;
      }
      const url = absoluteUrl(selected.file_base);
      const st  = $('.status');
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(url);
        } else {
          const ta = document.createElement('textarea');
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        st.textContent = 'Link kopiert.';
        setTimeout(() => st.textContent = '', 2000);
      } catch(e){
        console.error(e);
        st.textContent = 'Kopieren nicht möglich.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadList();

      // Dropdown Button
      $('#selector').addEventListener('click', togglePanel);

      // Suche im Panel
      $('#search').addEventListener('input', applyFilter);

      // Aktionen
      $('#open').addEventListener('click', openSelected);
      $('#copy').addEventListener('click', copySelected);

      // Klick außerhalb schließt das Panel
      document.addEventListener('click', (e) => {
        const panel = $('.panel');
        const selBtn = $('#selector');
        if (!panel.contains(e.target) && !selBtn.contains(e.target)){
          closePanel();
        }
      });

      // Service Worker
      if ('serviceWorker' in navigator){
        navigator.serviceWorker
          .register('/dp_intern/sw.js?v=01')
          .catch(console.error);
      }
    });
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card" role="region" aria-label="Dienstpläne">
      <h1>Dienstpläne</h1>
      <p class="muted">Mitarbeiter auswählen und Dienstplan öffnen oder Link kopieren.</p>

      <!-- Dropdown Button -->
      <div class="row">
        <button id="selector" type="button" class="selector" aria-haspopup="listbox" aria-expanded="false">
          <span id="selectorLabel" class="placeholder">Mitarbeiter wählen</span>
          <span class="chev">▾</span>
        </button>
      </div>

      <!-- Panel mit Suche und Liste -->
      <div class="panel" role="region" aria-label="Auswahl">
        <input id="search" class="search" type="text" placeholder="Suche nach Name …" aria-label="Suche">
        <div class="listbox" role="listbox" aria-label="Mitarbeiterliste"></div>
      </div>

      <div class="row">
        <button id="open" class="primary">Öffnen</button>
        <button id="copy" class="secondary">Link kopieren</button>
      </div>

      <div class="status" aria-live="polite"></div>
      <!-- <div class="footer">Quelle: <code>/dp_intern/links/Onedrive-Links.json</code></div> -->
    </section>
  </main>
</body>
</html>
